<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>施設予約カレンダー</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            margin-bottom: 20px;
        }
        
        .csv-upload {
            margin-bottom: 20px;
        }
        
        .csv-upload input {
            margin-right: 10px;
        }
        
        .calendar-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            height: 800px;
        }
        
        #calendar {
            height: 100%;
        }
        
        .no-events {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>施設予約カレンダー</h1>
        
        <div class="csv-upload">
            <input type="file" id="csvFile" accept=".csv" />
            <button onclick="uploadCSV()">CSV アップロード</button>
        </div>
    </div>
    
    <div class="calendar-container">
        <div id="loading" class="loading">読み込み中...</div>
        <div id="noEvents" class="no-events" style="display: none;">予約がありません</div>
        <div id="calendar"></div>
    </div>

    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@1.0.30/encoding.min.js"></script>
    <script>
        const HORIZON_DAYS = 30;
        const ROOMS = ['会議室(さくら)', '相談室(スミレ・コスモス)', 'テレワークルームA', 'テレワークルームB'];

        // Room colors for visual distinction
        const ROOM_COLORS = {
            '会議室(さくら)': '#ff69b4',
            '相談室(スミレ・コスモス)': '#9370db',
            'テレワークルームA': '#87ceeb',
            'テレワークルームB': '#90ee90'
        };

        let calendar;
        let currentEvents = [];

        // Initialize calendar
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new toastui.Calendar(calendarEl, {
                defaultView: 'month',
                useCreationPopup: false,
                useDetailPopup: true,
                calendars: ROOMS.map((room, index) => ({
                    id: room,
                    name: room,
                    backgroundColor: ROOM_COLORS[room] || '#007bff',
                    borderColor: ROOM_COLORS[room] || '#007bff',
                    dragBgColor: ROOM_COLORS[room] || '#007bff'
                })),
                template: {
                    monthDayname: function(dayname) {
                        return `<span class="toastui-calendar-weekday-name">${dayname.label}</span>`;
                    }
                }
            });
            
            console.log('[calendar] Calendar initialized');
        }

        // Filter events within the next 30 days
        function filterEventsBy30Days(events) {
            const now = new Date();
            const endDate = new Date(now.getTime() + HORIZON_DAYS * 24 * 60 * 60 * 1000);
            
            console.log('[calendar] Filtering events from', now.toISOString(), 'to', endDate.toISOString());
            
            return events.filter(event => {
                const eventDate = new Date(event.start);
                const isInRange = eventDate >= now && eventDate <= endDate;
                if (!isInRange) {
                    console.log('[calendar] Filtered out:', event.id, event.start);
                }
                return isInRange;
            });
        }

        // Convert API events to Toast UI Calendar format
        function convertToCalendarEvents(apiEvents) {
            console.log('[calendar] Converting API events:', apiEvents);
            
            const calendarEvents = apiEvents.map(event => {
                const startDate = new Date(event.start);
                const endDate = new Date(event.end);
                
                return {
                    id: event.id.toString(),
                    calendarId: event.room,
                    title: `${event.name}`,
                    category: 'time',
                    start: startDate,
                    end: endDate,
                    backgroundColor: ROOM_COLORS[event.room] || '#007bff',
                    borderColor: ROOM_COLORS[event.room] || '#007bff',
                    color: '#ffffff'
                };
            });
            
            console.log('[calendar] Converted calendar events:', calendarEvents);
            return calendarEvents;
        }

        // Fetch events from API
        async function fetchEvents() {
            console.log('[calendar] Fetching events from API...');
            
            try {
                const response = await fetch('/api/events');
                const data = await response.json();
                
                console.log('[calendar] Raw API response:', data);
                
                if (!data.events || !Array.isArray(data.events)) {
                    console.error('[calendar] Invalid API response format');
                    showNoEvents();
                    return;
                }
                
                currentEvents = data.events;
                console.log('[calendar] Current events:', currentEvents);
                
                // Filter by 30 days
                const filteredEvents = filterEventsBy30Days(currentEvents);
                console.log('[calendar] Filtered events (30 days):', filteredEvents);
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                if (filteredEvents.length === 0) {
                    showNoEvents();
                    return;
                }
                
                // Show calendar and hide no events message
                document.getElementById('noEvents').style.display = 'none';
                document.getElementById('calendar').style.display = 'block';
                
                // Convert and add events to calendar
                const calendarEvents = convertToCalendarEvents(filteredEvents);
                
                // Clear existing events
                calendar.clear();
                
                // Add events to calendar
                calendar.createEvents(calendarEvents);
                
                console.log('[calendar] Events successfully added to calendar');
                
            } catch (error) {
                console.error('[calendar] Error fetching events:', error);
                document.getElementById('loading').textContent = 'エラーが発生しました';
            }
        }

        function showNoEvents() {
            document.getElementById('calendar').style.display = 'none';
            document.getElementById('noEvents').style.display = 'block';
        }

        // CSV upload function
        function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSVファイルを選択してください');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Detect encoding and convert to UTF-8 if needed
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    let text;
                    if (typeof Encoding !== 'undefined') {
                        const detectedEncoding = Encoding.detect(uint8Array);
                        if (detectedEncoding === 'SJIS' || detectedEncoding === 'EUCJP') {
                            const unicodeArray = Encoding.convert(uint8Array, {
                                to: 'UNICODE',
                                from: detectedEncoding
                            });
                            text = Encoding.codeToString(unicodeArray);
                        } else {
                            text = new TextDecoder('utf-8').decode(arrayBuffer);
                        }
                    } else {
                        text = new TextDecoder('utf-8').decode(arrayBuffer);
                    }
                    
                    // Parse CSV
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            const events = results.data.map((row, index) => {
                                return {
                                    id: `csv_${index}`,
                                    room: row['部屋'] || row['施設'] || row['room'],
                                    name: row['氏名'] || row['予約者'] || row['name'],
                                    start: row['開始'] || row['開始時刻'] || row['start'],
                                    end: row['終了'] || row['終了時刻'] || row['end']
                                };
                            }).filter(event => event.room && event.name && event.start && event.end);
                            
                            console.log('[calendar] CSV events loaded:', events);
                            currentEvents = events;
                            
                            // Process the loaded events
                            const filteredEvents = filterEventsBy30Days(events);
                            const calendarEvents = convertToCalendarEvents(filteredEvents);
                            
                            // Clear and add to calendar
                            calendar.clear();
                            calendar.createEvents(calendarEvents);
                            
                            // Show calendar
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('noEvents').style.display = 'none';
                            document.getElementById('calendar').style.display = 'block';
                            
                            alert(`${events.length}件の予約データを読み込みました`);
                        },
                        error: function(error) {
                            console.error('CSV parse error:', error);
                            alert('CSVファイルの解析に失敗しました');
                        }
                    });
                } catch (error) {
                    console.error('File read error:', error);
                    alert('ファイルの読み込みに失敗しました');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[calendar] DOM loaded, initializing...');
            
            initCalendar();
            fetchEvents();
            
            // Auto-refresh every 30 seconds
            setInterval(fetchEvents, 30000);
        });
    </script>
</body>
</html>